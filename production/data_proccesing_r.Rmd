---
title: "Preparacion de datos"
subtitle: "Socializacion de la Participación política: familia y escuela"
output: 
  html_document: 
    toc: yes
    code_folding: hide
    toc_float: 
      collapsed: true
      smooth_scroll: false
      number_sections: true
    css: "https://jciturras.github.io/ayudantia-sol3051/style.css"    
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE,
                      error = TRUE)
options(scipen=999)
```

# Librerias 

```{r}
pacman::p_load(sjmisc, 
               readstata13, 
               car, 
               sjlabelled, 
               dplyr, 
               sjPlot, 
               psych, 
               lavaan, 
               summarytools
               )  
```

# Cargar datos

```{r}
est_data <- read.dta13(file = "https://github.com/formacionciudadana/data-paces/blob/main/docs/paces/data/base_estudiantesv2.dta?raw=true")
apod_data <- read.dta13(file ="https://github.com/formacionciudadana/data-paces/blob/main/docs/paces/data/base_apoderadosv2.dta?raw=true")
```

# Creacion data frame 

* P31 A - C corresponden a Participacion Formal
* P33 A - H corresponden a Participacion Activista y Activista Disruptivo
* P38 A - E corresponden a Socializacion politico familiar indirecta
* P48 estudiantes A - C corresponden a Socializacion politico familiar directa
* P49 A - G corresponden a Apertura a la Discusion en el Aula, como dimension de SPE
* P50 A - G corresponden a Estrategias de aprendizaje civico activo en la escuela, como dimension de SPE
* Control y caracterizacion. P58 Sexo. P68 estudiantes: Número de libros. P55 Apoderados: ingresos.

```{r}
est_data <- est_data %>% dplyr::select(P31A, 
                                P31B,   
                                P31C,
                                P33A,
                                P33B,
                                P33C,
                                P33D,
                                P33E,
                                P33F,
                                P33G,
                                P33H,
                                P38A,
                                P38B,
                                P38C,
                                P38D,
                                P38E,
                                P48A,
                                P48B,
                                P48C,
                                P49A,
                                P49B,
                                P49C,
                                P49D,
                                P49E,
                                P49F,
                                P49G,
                                P50A,
                                P50B,
                                P50C,
                                P50D,
                                P50E,
                                P50F,
                                P50G,
                                P58,
                                P66,
                                P67,
                                P68,
                                REGION, 
                                Dependencia,
                                folio=FOLIO,
                                RBDE=RBD)

apod_data <- apod_data %>% dplyr::select(P17,
                                  P18,
                                  P19,
                                  P20A,
                                  P20B,
                                  P20C,
                                  P20D,
                                  P21A,
                                  P21B,
                                  P21C,
                                  P21D,
                                  P21E,
                                  P21G,
                                  P21H,
                                  P39,
                                  P41,
                                  P45,
                                  P47,
                                  P55,
                                  folio=FOLIO_EST,
                                  folio_pa=FOLIO,
                                  RBDA=RBD)

```

## Participación política (base estudiantes)
```{r}
est_data <- est_data %>% mutate(int_mun = P31A) #Intencion de Voto en Municipales
est_data <- est_data %>% mutate(int_pre = P31B) #Intencion de voto en Presidenciales
est_data <- est_data %>% mutate(int_inf = P31C) #Intencion de informarse
est_data <- est_data %>% mutate(par_fir = P33A) #Desde A hasta H, actividades realizadas durante los ultimos 12 meses
est_data <- est_data %>% mutate(par_marau = P33B)
est_data <- est_data %>% mutate(par_marnoau = P33C)
est_data <- est_data %>% mutate(par_bloq = P33D)
est_data <- est_data %>% mutate(par_pared = P33E)
est_data <- est_data %>% mutate(par_toma = P33F)
est_data <- est_data %>% mutate(par_servcom = P33G)
est_data <- est_data %>% mutate(par_reupol = P33H)
```

## Socialización política escolar (base estudiantes)

```{r}
est_data <- est_data %>% mutate(aper_abiert = P49A) #Apertura a la discusion (49A a 49G)
est_data <- est_data %>% mutate(aper_expr = P49B)
est_data <- est_data %>% mutate(aper_act = P49C)
est_data <- est_data %>% mutate(aper_dist = P49D)
est_data <- est_data %>% mutate(aper_estim = P49E)
est_data <- est_data %>% mutate(aper_punt = P49F)
est_data <- est_data %>% mutate(aper_reflx = P49G)
est_data <- est_data %>% mutate(civ_tall = P50A) #Estrategias de aprendizaje civico activo (50A a 50F)
est_data <- est_data %>% mutate(civ_simul = P50B)
est_data <- est_data %>% mutate(civ_camp = P50C)
est_data <- est_data %>% mutate(civ_foros = P50D)
est_data <- est_data %>% mutate(civ_charlas = P50E)
est_data <- est_data %>% mutate(civ_medio = P50F)
est_data <- est_data %>% mutate(civ_comun = P50G)
```

## Socialización política familiar (base estudiantes)
```{r}
est_data <- est_data %>% mutate(conv_noticias = P38A) #conversación con los padres de noticias de Chile y el mundo
est_data <- est_data %>% mutate(conv_colegio = P38B) #conversación con los padres sobre colegio
est_data <- est_data %>% mutate(conv_permisos = P38C) #conversación con los padres sobre permisos
est_data <- est_data %>% mutate(conv_amistades = P38D) #conversación con los padres sobre amigos
est_data <- est_data %>% mutate(conv_sociopol = P38E) #conversación con los padres de temas politicos y sociales
est_data <- est_data %>% mutate(pp_voto_presi = P48A)#Participación política padres: Votar en presidenciales 2017
est_data <- est_data %>% mutate(pp_marcha = P48B) #Participación política padreS: Marchar
est_data <- est_data %>% mutate(pp_act_comu = P48C) #Participación política padres: Participar en actividades comunitarias 
```

## Socialización política familiar (base apoderado)
```{r}
apod_data <- apod_data %>% mutate(voto_apod = P17) #Votacion en las ultimas elecciones
apod_data <- apod_data %>% mutate(voto_prox = P18) #Votacion el domingo
apod_data <- apod_data %>% mutate(voto_imp = P19) #Importancia de elecciones
apod_data <- apod_data %>% mutate(act_peticion = P20A) #Actividad: peticion 
apod_data <- apod_data %>% mutate(act_marcha = P20B) #Actividad: marcha
apod_data <- apod_data %>% mutate(act_voluntariado = P20C) #Actividad: voluntariado 
apod_data <- apod_data %>% mutate(act_reu_sociopol = P20D) #Actividad: reunion sociopolitica 
apod_data <- apod_data %>% mutate(org_juntavecinos = P21A) #Org Voluntaria: Junta de vecinos  
apod_data <- apod_data %>% mutate(org_iglesia = P21B) #Org Voluntaria: iglesia 
apod_data <- apod_data %>% mutate(org_ppol = P21C) #Org Voluntaria: partido politico 
apod_data <- apod_data %>% mutate(org_sindicato = P21D) #Org Voluntaria: sindicato  
apod_data <- apod_data %>% mutate(org_asocprof = P21E) #Org Voluntaria: asociacion profesional 
apod_data <- apod_data %>% mutate(org_caridad = P21G) #Org Voluntaria: caridad 
apod_data <- apod_data %>% mutate(org_cpadres = P21H) #Org Voluntaria: centros de padres
```


# Nombrar variables 

* control y caracterizacion socioeconomica

```{r}
est_data  <- est_data %>% mutate(sexo = P58)
apod_data <- apod_data %>% mutate(sexo_apod = P39)
est_data  <- est_data %>% mutate(region = REGION) #Region
est_data  <- est_data %>% mutate(dependencia = Dependencia) #Dependencia
est_data  <- est_data %>% mutate(ed_padre = P66) #Reportada por estudiantes
est_data  <- est_data %>% mutate(ed_madre = P67) #Reportada por estudiante
apod_data <- apod_data %>% mutate(educ_apod = P45) #Reportada por apoderados
apod_data <- apod_data %>% mutate(ingresos = P55) #Ingresos
apod_data <- apod_data %>% mutate(cantidad = P41) #Cantidad de personas en el hogar
```

# Etiquetar variables
```{r}
#Etiquetar variables de participacion (formal y activistas)
est_data$int_mun <- set_label(x = est_data$int_mun ,label = "Intencion de voto en Municipales")
est_data$int_pre <- set_label(x = est_data$int_pre ,label = "Intencion de voto en Presidenciales")
est_data$int_inf <- set_label(x = est_data$int_inf ,label = "Intencion de informarse antes de elecciones")
est_data$par_fir <- set_label(x = est_data$par_fir ,label = "est_data: Firmar una peticion")
est_data$par_marau <- set_label(x = est_data$par_marau ,label = "est_data: Marcha autorizada")
est_data$par_marnoau <- set_label(x = est_data$par_marnoau ,label = "est_data: Marcha no autorizada")
est_data$par_bloq <- set_label(x = est_data$par_bloq,label = "PARTICIPACIoN: Bloqueo de calles")
est_data$par_pared <- set_label(x = est_data$par_pared,label = "PARTICIPACIoN: Pintar Paredes")
est_data$par_toma <- set_label(x = est_data$par_toma ,label = "PARTICIPACION: EN tomas")
est_data$par_servcom <- set_label(x = est_data$par_servcom ,label = "PARTICIPACION: Trabajos comunitarios")
est_data$par_reupol <- set_label(x = est_data$par_reupol ,label = "PARTICIPACION: Reuniones politicas")
#Etiquetar variables de Socialización política Escolar
#Apertura a la discusion en el aula
est_data$aper_abiert <- set_label(x = est_data$aper_abiert ,label = "APER: Estudiantes pueden manifestar desacuerdo en clases")
est_data$aper_expr <- set_label(x = est_data$aper_expr ,label = "APER: Profesores estimulan la opinion de estudiantes")
est_data$aper_act <- set_label(x = est_data$aper_act ,label = "APER: Estudiantes plantean temas de actualidad politica en clases")
est_data$aper_dist <- set_label(x = est_data$aper_dist ,label = "APER: Estudiantes expresan opiniones diversas")
est_data$aper_estim <- set_label(x = est_data$aper_estim ,label = "APER: Profesores estimulan dialogo entre gente que opina en clases")
est_data$aper_punt <- set_label(x = est_data$aper_punt ,label = "APER: Profesores exponen temas desde diversos puntos de vista")
est_data$aper_reflx <- set_label(x = est_data$aper_reflx ,label = "APER: Profesores fomentan reflexion y critica")
#Aprendizaje civico activo
est_data$civ_tall    <- set_label(x = est_data$civ_tall ,label = "ACA: Talleres y Jornadas") #ACA = aprendizaje civico activo
est_data$civ_simul   <- set_label(x = est_data$civ_simul ,label = "ACA: Simulacion de elecciones")
est_data$civ_camp    <- set_label(x = est_data$civ_camp ,label = "ACA: Campañas de elecciones de CAA")
est_data$civ_foros   <- set_label(x = est_data$civ_foros ,label = "ACA: Foros y Debates")
est_data$civ_charlas <- set_label(x = est_data$civ_charlas ,label = "ACA: Charlas con invitados")
est_data$civ_medio   <- set_label(x = est_data$civ_medio ,label = "ACA: Actividades Medioambientales")
est_data$civ_comun   <- set_label(x = est_data$civ_comun ,label = "ACA: Servicio a la Comunidad")
#Etiquetar variables de Socialización política Familiar
# Indirecta
est_data$conv_noticias <- set_label(x = est_data$conv_noticias ,label = "conversación: sobre noticias de Chile y el mundo") 
est_data$conv_colegio  <- set_label(x = est_data$conv_colegio ,label = "conversación: sobre colegio y trabajos escolares")
est_data$conv_permisos <- set_label(x = est_data$conv_permisos ,label = "conversación: sobre permisos")
est_data$conv_amistades<- set_label(x = est_data$conv_amistades ,label = "conversación: sobre lo que haces con tus amigos")
est_data$conv_sociopol <- set_label(x = est_data$conv_sociopol ,label = "conversación: sobre temas politicos y sociales") 
# Directa
est_data$pp_voto_presi <- set_label(x = est_data$pp_voto_presi ,label = "Part Politica: Votacion en presidenciales 2017") 
est_data$pp_marcha <- set_label(x = est_data$pp_marcha ,label = "Part Politica: Marchar") 
est_data$pp_act_comu <- set_label(x = est_data$pp_act_comu ,label = "Part Politica: Participar en actividades comunitarias") 
apod_data$voto_apod <- set_label(x = apod_data$voto_apod ,label = "Voto: ultimas elecciones") 
apod_data$voto_prox <- set_label(x = apod_data$voto_prox ,label = "Voto: proximo domingo") 
apod_data$voto_imp <- set_label(x = apod_data$voto_imp ,label = "Voto: importancia elecciones") 
apod_data$act_peticion <- set_label(x = apod_data$act_peticion ,label = "Actividad: peticion") 
apod_data$act_marcha <- set_label(x = apod_data$act_marcha ,label = "Actividad: marcha")
apod_data$act_voluntariado <- set_label(x = apod_data$act_voluntariado ,label = "Actividad: voluntariado") 
apod_data$act_reu_sociopol <- set_label(x = apod_data$act_reu_sociopol ,label = "Actividad: reunion sociopolitica") 
apod_data$org_juntavecinos <- set_label(x = apod_data$org_juntavecinos ,label = "Org Voluntaria: Junta de vecinos") 
apod_data$org_iglesia <- set_label(x = apod_data$org_iglesia ,label = "Org Voluntaria: Iglesia") 
apod_data$org_ppol <- set_label(x = apod_data$org_ppol ,label = "Org Voluntaria: partido politico") 
apod_data$org_sindicato <- set_label(x = apod_data$org_sindicato ,label = "Org Voluntaria: sindicato")
apod_data$org_asocprof <- set_label(x = apod_data$org_asocprof ,label = "Org Voluntaria: asociacion profesional") 
apod_data$org_caridad <- set_label(x = apod_data$org_caridad ,label = "Org Voluntaria: caridad") 
apod_data$org_cpadres <- set_label(x = apod_data$org_cpadres ,label = "Org Voluntaria: centros de padres") 
## Etiquetar variables de control y recursos
est_data$sexo <- set_label(x = est_data$sexo,label = "Sexo")
apod_data$sexo_apod <- set_label(x = apod_data$sexo_apod,label = "Sexo apoderado")
est_data$region <- set_label(x = est_data$region ,label = "Region")
est_data$dependencia <- set_label(x = est_data$dependencia ,label = "Dependencia")
apod_data$ingresos <- set_label(x = apod_data$ingresos ,label = "Ingresos")
est_data$ed_madre <- set_label (x = est_data$ed_madre ,label ="Educación Madre")
est_data$ed_padre <- set_label (x = est_data$ed_padre ,label ="Educación Padre")
apod_data$educ_apod <- set_label (x = apod_data$educ_apod ,label ="Educación padre/madre")
apod_data$cantidad <- set_label (x = apod_data$cantidad ,label ="Cantidad de Personas en Hogar")
```

* Variables de apertura deben ser cambiadas en su orden (de positivo a negativo, borrar categorias 5 y 9)
* Variables de aprendizaje activo deben ser borrado categorias 3 y 9
* Decretar casos perdidos y eliminar sus antiguas etiquetas

```{r}
# Participación política
est_data$int_mun <- set_na(est_data$int_mun, na = c(4,9), drop.levels = TRUE, as.tag = FALSE)
est_data$int_pre <- set_na(est_data$int_pre, na = c(4,9), drop.levels = TRUE, as.tag = FALSE)
est_data$int_inf <- set_na(est_data$int_inf, na = c(4,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_fir<- set_na(est_data$par_fir, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_marau <- set_na(est_data$par_marau, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_marnoau <- set_na(est_data$par_marnoau, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_toma <- set_na(est_data$par_toma, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_bloq <- set_na(est_data$par_bloq, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_pared <- set_na(est_data$par_pared, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_servcom <- set_na(est_data$par_servcom, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$par_reupol <- set_na(est_data$par_reupol, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
# SPE
est_data$aper_abiert <- set_na(est_data$aper_abiert, na = c(5,9), drop.levels = TRUE, as.tag = FALSE) #Apertura a la discusion
est_data$aper_expr <- set_na(est_data$aper_expr, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
est_data$aper_act <- set_na(est_data$aper_act, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
est_data$aper_dist <- set_na(est_data$aper_dist, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
est_data$aper_estim <- set_na(est_data$aper_estim, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
est_data$aper_punt <- set_na(est_data$aper_punt, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
est_data$aper_reflx <- set_na(est_data$aper_reflx, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
est_data$civ_tall <- set_na(est_data$civ_tall, na = c(3,9), drop.levels = TRUE, as.tag = FALSE) # Estrategias de aprendizaje civico activo
est_data$civ_simul <- set_na(est_data$civ_simul, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$civ_camp <- set_na(est_data$civ_camp, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$civ_foros <- set_na(est_data$civ_foros, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$civ_charlas <- set_na(est_data$civ_charlas, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$civ_medio <- set_na(est_data$civ_medio, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
est_data$civ_comun <- set_na(est_data$civ_comun, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
# SPF
est_data$conv_noticias <- set_na(est_data$conv_noticias, na = c(5, 9), drop.levels = TRUE, as.tag = FALSE)
est_data$conv_colegio <- set_na(est_data$conv_colegio, na = c(5, 9), drop.levels = TRUE, as.tag = FALSE)
est_data$conv_permisos <- set_na(est_data$conv_permisos, na = c(5, 9), drop.levels = TRUE, as.tag = FALSE)
est_data$conv_amistades <- set_na(est_data$conv_amistades, na = c(5, 9), drop.levels = TRUE, as.tag = FALSE)
est_data$conv_sociopol <- set_na(est_data$conv_sociopol, na = c(5, 9), drop.levels = TRUE, as.tag = FALSE)

#SPFD
est_data$pp_voto_presi <- set_na(est_data$pp_voto_presi, na = c(3, 9), drop.levels = TRUE, as.tag = FALSE)
est_data$pp_marcha <- set_na(est_data$pp_marcha, na = c(9), drop.levels = TRUE, as.tag = FALSE)
est_data$pp_act_comu <- set_na(est_data$pp_act_comu, na = c(9), drop.levels = TRUE, as.tag = FALSE)

apod_data$voto_apod <- set_na(apod_data$voto_apod, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$voto_prox <- set_na(apod_data$voto_prox, na = c(3, 9), drop.levels = TRUE, as.tag = FALSE)
apod_data$voto_imp <- set_na(apod_data$voto_imp, na = c(9), drop.levels = TRUE, as.tag = FALSE)

apod_data$act_peticion <- set_na(apod_data$act_peticion, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$act_marcha <- set_na(apod_data$act_marcha, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$act_voluntariado <- set_na(apod_data$act_voluntariado, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$act_reu_sociopol <- set_na(apod_data$act_reu_sociopol, na = c(9), drop.levels = TRUE, as.tag = FALSE)

apod_data$org_juntavecinos <- set_na(apod_data$org_juntavecinos, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$org_iglesia <- set_na(apod_data$org_iglesia, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$org_ppol <- set_na(apod_data$org_ppol, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$org_sindicato <- set_na(apod_data$org_sindicato, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$org_asocprof <- set_na(apod_data$org_asocprof, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$org_caridad <- set_na(apod_data$org_caridad, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$org_cpadres <- set_na(apod_data$org_cpadres, na = c(9), drop.levels = TRUE, as.tag = FALSE)

#Variables de control y recursos socioeconomicos
est_data$sexo <- set_na(est_data$sexo, na = c(3,4,9), drop.levels = TRUE, as.tag = FALSE)
apod_data$sexo_apod <- set_na(apod_data$sexo_apod, na = c(3,9), drop.levels = TRUE, as.tag = FALSE)
apod_data$ingresos <- set_na(apod_data$ingresos, na = c(12, 13), drop.levels = TRUE, as.tag = FALSE)
est_data$ed_madre <- set_na(est_data$ed_madre, na = c(8, 9), drop.levels = TRUE, as.tag = FALSE)
est_data$ed_padre <- set_na(est_data$ed_padre, na = c(8, 9), drop.levels = TRUE, as.tag = FALSE)
apod_data$educ_apod <- set_na(apod_data$educ_apod, na = c(9), drop.levels = TRUE, as.tag = FALSE)
apod_data$cantidad <- set_na(apod_data$cantidad, na = c(999), drop.levels = TRUE, as.tag = FALSE)
```

* Comparacion de algunas variables nuevas y antiguas (variables de interes)

```{r}
table(apod_data$P20B, apod_data$act_marcha)
```

# Merge base estudiantes y apoderados 

```{r}
data <- left_join(x=est_data, y=apod_data, by="folio", suffix=c(".x", ".y"))
```

* Comparacion de algunas variables nuevas y antiguas (variables de interes, despues de merge)

```{r}
table(data$P20B, data$act_marcha)
```

# Variables Socioeconomicas

## Ingresos

```{r}
data$ingresos_num[data$ingresos == 1] <- 50500 
data$ingresos_num[data$ingresos == 2] <- 117500
data$ingresos_num[data$ingresos == 3] <- 156500
data$ingresos_num[data$ingresos == 4] <- 201500
data$ingresos_num[data$ingresos == 5] <- 257500
data$ingresos_num[data$ingresos == 6] <- 324500
data$ingresos_num[data$ingresos == 7] <- 403000
data$ingresos_num[data$ingresos == 8] <- 724000
data$ingresos_num[data$ingresos == 9] <- 1500000
data$ingresos_num[data$ingresos == 10] <- 2500000
data$ingresos_num[data$ingresos == 11] <- 3500000

frq(data$ingresos_num)

data$ingresos_pc <- data$ingresos_num/data$cantidad
data$ingresos_pc <- trunc(data$ingresos_pc)
```

### Ingreso tramos 
```{r}
data$ingresos_factor <- factor(data$ingresos, levels = c(1,2,3,4,5,6,7,8,9,10,11,99), 
                                    labels = c("Menos de $101.000 mensuales liquidos",
                                               "De $101.001 a $134.000 mensuales liquidos",
                                               "De $134.001 a $179.000 mensuales liquidos",
                                               "De $179.001 a $224.000 mensuales liquidos",
                                               "De $224.001 a $291.000 mensuales liquidos",
                                               "De $291.001 a $358.000 mensuales liquidos",
                                               "De $358.001 a $448.000 mensuales liquidos",
                                               "De $448.001 a $1.000.000 mensuales liquidos",
                                               "De $1.000.001 a $2.000.000 mensuales liquidos",
                                               "De $2.000.001 a $3.000.000 mensuales liquidos",
                                               "Mas de $3.000.000 mensuales liquidos",
                                               "No sabe/No responde"))
```

### Quintiles Ingresos per capita 

```{r}
data <- data %>% mutate(quintiles_ingresos_pc = ntile(ingresos_pc,5)) #Recuperar NA
data$quintiles_ingresos_pc[is.na(data$quintiles_ingresos_pc)] <- 99 # Construccion ingresos per capita quintiles factor
data$quintiles_ingresos_pc_factor <- factor(data$quintiles_ingresos_pc, 
                                            levels = c(1,2,3,4,5,99), 
                                            labels = c("Quintil 1", "Quintil 2", "Quintil 3", "Quintil 4", "Quintil 5", "No sabe/No responde")) 
data$quintiles_ingresos_pc_factor <- set_label(data$quintiles_ingresos_pc_factor,label = "Quintil de ingreso per capita")
## Eliminar 99 de la variable numerica
data$quintiles_ingresos_pc[data$quintiles_ingresos_pc == 99] <- NA
data$quintiles_ingresos_pc <- set_label(data$quintiles_ingresos_pc,label = "Quintil de ingreso per capita")
frq(data$quintiles_ingresos_pc)
```


## Libros en el hogar

```{r}
data <- data %>% mutate(est_libros = P68) #Libros reportados por estudiantes
data <- data %>% mutate(pad_libros = P47) #Libros reportados por apoderados
data$est_libros <- set_label(x = data$est_libros,label = "Número de libros estudiantes")
data$pad_libros <- set_label(x = data$pad_libros,label = "Número de libros apoderados")
data$est_libros <- set_na(data$est_libros, na = c(8,9), drop.levels = TRUE, as.tag = FALSE)
data$pad_libros <- set_na(data$pad_libros, na = c(8,9), drop.levels = TRUE, as.tag = FALSE)

#frq(data$pad_libros)
data$total_libros <- ifelse(is.na(data$pad_libros), data$est_libros, data$pad_libros)
data$total_libros <- car::recode(data$total_libros, "6=5")
data$total_libros <- as.factor(data$total_libros)
data$total_libros <- set_labels(data$total_libros,
                                labels=c( "Entre 0 y 10 libros"=1,
                                          "Entre 11 y 25 libros"=2,
                                          "Entre 26 y 100 libros"=3,
                                          "Entre 101 y 200 libros"=4,
                                          "Mas de 200 libros"=5))
#Factorizar y recodificar variable original de libros padres
data$pad_libros <- car::recode(data$pad_libros, "6=5;c(4,5)=4")
table(data$pad_libros)
data$pad_libros <- factor(data$pad_libros,
                          levels = c(1:4),
                          labels = c("Entre 0 y 10 libros",
                                     "Entre 11 y 25 libros",
                                     "Entre 26 y 100 libros",
                                     "101 libros o más "))
data$pad_libros <- set_label(data$pad_libros,label = "Número de libros en el hogar")
data$libros_num <- as.numeric(data$total_libros) #Se crea variable libros numerica
```


## Educación padre y madre

```{r}
data$educ_padres <- ifelse(data$ed_madre>data$ed_padre,data$ed_madre,data$ed_padre) # Crear variable nueva
data$educ_padres <- set_label(x = data$educ_padres,label = "Nivel Educaciónal mas alto de los padres") # Etiquetar variable nueva
data$educ_padres <- car::recode(data$educ_padres, "2=1; 3=2; 4=3; 5=4")
frq(data$educ_padres)
```

### Factor de variable combinada

```{r}
data$educ_padres_factor <- factor(data$educ_padres, levels = c(1,2,3,4), 
                                  labels = c("8vo básico o menos", 
                                             "Educación media", 
                                             "Educación Técnica superior", 
                                             "Educación universitaria o posgrados"))
```


### Educación padres (reportada por ellos mismos)

```{r}
data$educ_apod <- factor(data$educ_apod, levels = c(1,2,3,4), 
                             labels = c("8vo básico o menos", 
                                        "Educación media", 
                                        "Educación Técnica superior", 
                                        "Educación universitaria o posgrados"))
data$educ_apod <- set_label(data$educ_apod,"Nivel Educaciónal apoderado/a")

```

# Sexo estudiante

* variable dummy Hombre =1, Mujer = 0 

```{r}
data$sexo <- car::recode(data$sexo,"2=0",as.factor = TRUE)
data$sexo <- factor(data$sexo,
                    levels = c(0,1),
                    labels=c( "Mujer","Hombre"))
# data$sexo <- set_labels(data$sexo,
#                            labels=c( "Mujer"=0,
#                                      "Hombre"=1))
data$sexo <- set_label(x = data$sexo ,label = "Sexo estudiante") 
```

# Voto apoderado

```{r}
data$voto_apod <- car::recode(data$voto_apod, "2=0",as.factor = TRUE)
data$voto_apod <- factor(data$voto_apod,
                         levels = c(0,1),
                         labels=c( "No","Si"))
data$voto_apod <- set_label(x = data$voto_apod ,label = "Voto: ultimas elecciones") 
# data$voto_apod <- set_labels(data$voto_apod,
#                            labels=c( "No"=0,
#                                      "Si"=1))
```


# Transformacion a dummy

## Participacion formal

```{r}
data$int_inf <- car::recode(data$int_inf, "1=0;2=1;3=1")
data$int_inf <- set_labels(data$int_inf,
                           labels=c( "No"=0,
                                     "Si"=1))

data$int_mun <- car::recode(data$int_mun, "1=0;2=1;3=1")
data$int_mun <- set_labels(data$int_mun,
                           labels=c( "No"=0,
                                     "Si"=1))

data$int_pre <- car::recode(data$int_pre, "1=0;2=1;3=1")
data$int_pre <- set_labels(data$int_pre,
                           labels=c( "No"=0,
                                     "Si"=1))
```


## Participacion de estudiantes (disruptivo y no disruptivo)

```{r}
data$par_fir <- car::recode(data$par_fir, "2=0")
data$par_fir <- set_labels(data$par_fir,
                                    labels=c( "No"=0,
                                              "Si"=1))

data$par_marau <- car::recode(data$par_marau, "2=0")
data$par_marau <- set_labels(data$par_marau,
                                      labels=c( "No"=0,
                                                "Si"=1))

data$par_marnoau <- car::recode(data$par_marnoau, "2=0")
data$par_marnoau <- set_labels(data$par_marnoau,
                                        labels=c( "No"=0,
                                                  "Si"=1))

data$par_toma <- car::recode(data$par_toma, "2=0")
data$par_toma <- set_labels(data$par_toma,
                                     labels=c( "No"=0,
                                               "Si"=1))

data$par_bloq <- car::recode(data$par_bloq, "2=0")
data$par_bloq <- set_labels(data$par_bloq,
                                     labels=c( "No"=0,
                                               "Si"=1))

data$par_pared <- car::recode(data$par_pared, "2=0")
data$par_pared <- set_labels(data$par_pared,
                                      labels=c( "No"=0,
                                                "Si"=1))

data$par_servcom <- car::recode(data$par_servcom, "2=0")
data$par_servcom <- set_labels(data$par_servcom,
                                        labels=c( "No"=0,
                                                  "Si"=1))

data$par_reupol <- car::recode(data$par_reupol, "2=0")
data$par_reupol <- set_labels(data$par_reupol,
                                       labels=c( "No"=0,
                                                 "Si"=1))
```

## Aprendizaje civico activo 
* Orden y conversion en variables (data$civ_)
```{r}
data$civ_tall <- car::recode(data$civ_tall, "2=0")
data$civ_tall <- set_labels(data$civ_tall,
                            labels=c( "No"=0,
                                      "Si"=1))

data$civ_simul <- car::recode(data$civ_simul, "2=0")
data$civ_simul <- set_labels(data$civ_simul,
                             labels=c( "No"=0,
                                       "Si"=1))

data$civ_camp <- car::recode(data$civ_camp, "2=0")
data$civ_camp <- set_labels(data$civ_camp,
                            labels=c( "No"=0,
                                      "Si"=1))

data$civ_foros <- car::recode(data$civ_foros, "2=0")
data$civ_foros <- set_labels(data$civ_foros,
                             labels=c( "No"=0,
                                       "Si"=1))

data$civ_charlas <- car::recode(data$civ_charlas, "2=0")
data$civ_charlas <- set_labels(data$civ_charlas,
                               labels=c( "No"=0,
                                         "Si"=1))

data$civ_medio <- car::recode(data$civ_medio, "2=0")
data$civ_medio <- set_labels(data$civ_medio,
                             labels=c( "No"=0,
                                       "Si"=1))

data$civ_comun <- car::recode(data$civ_comun, "2=0")
data$civ_comun <- set_labels(data$civ_comun,
                             labels=c( "No"=0,
                                       "Si"=1))
```
                                       

* Se genera un indice de las variables de Socialización política en el aula data$civ

```{r}
df_civico <- data.frame(data$civ_tall, data$civ_simul, data$civ_camp, 
                        data$civ_foros, data$civ_charlas, data$civ_medio, data$civ_comun)

tetrachoric(df_civico) #Correlaciones

#Se genera un psych::alpha de cronbach para saber si los indicadores se comportan como indice
alfa_civ <- psych::alpha(df_civico)
alfa_civ

#Se genera un indice sumativo
data$civico <- (data$civ_tall + data$civ_simul + data$civ_camp + 
                data$civ_foros + data$civ_charlas + data$civ_medio + data$civ_comun)
frq(data$civico)
data$civico<- set_label(data$civico,label = "Indice aprendizaje cívico activo en la escuela")

#Apertura a la discusion en el aula data$aper
df_apertura <- data.frame(data$aper_abiert, data$aper_expr, data$aper_dist, 
                            data$aper_estim, data$aper_punt, data$aper_reflx)
#Correlaciones
polychoric(df_apertura)
#Como todos los valorees de las correlaciones son arriba de 0,7, se integran todas
data$apertura <- (data$aper_abiert + data$aper_expr + data$aper_dist + 
                  data$aper_estim + data$aper_punt + data$aper_reflx)/6

data$apertura<- set_label(data$apertura,label = "Indice apertura a la discusión en el aula")
#Se genera el alfa de cronbach para evaluar fiabilidad
alfa_conv <- psych::alpha(df_apertura)
alfa_conv
```

# Variables de Socialización política familiar
## Socialización política indirecta (conversación)
```{r}
df_conv <- data.frame(data$conv_sociopol, data$conv_noticias, data$conv_colegio, 
                      data$conv_permisos, data$conv_amistades)
```

### Correlaciones
```{r}
polychoric(df_conv)
#Alfa de cronbach para fiabilidad
alfa_conv <- psych::alpha(df_conv)
alfa_conv
# Se realiza un indice con aquellas variables que tienen mas sentido teorico y mayor correlacion
data$conversacion <- (data$conv_sociopol + data$conv_noticias)/2
data$conversacion<- set_label(data$conversacion,label = "Indice Socialización política indirecta (conversación)")
frq(data$conversacion)
```

## Participación política de padres (base estudiantes) 
```{r}
#Variables dummy, Participación política apod (data$pp_)
data$pp_act_comu <- car::recode(data$pp_act_comu, "2=0")
data$pp_act_comu <- set_labels(data$pp_act_comu,
                               labels=c( "No"=0,
                                         "Si"=1))
data$pp_voto_presi <- car::recode(data$pp_voto_presi, "2=0")
data$pp_voto_presi <- set_labels(data$pp_voto_presi,
                                 labels=c( "No"=0,
                                           "Si"=1))
data$pp_marcha <- car::recode(data$pp_marcha, "2=0")
data$pp_marcha <- set_labels(data$pp_marcha,
                             labels=c( "No"=0,
                                       "Si"=1))
df_pp <- data.frame(data$pp_act_comu, data$pp_marcha, data$pp_voto_presi)
```

### Correlaciones
```{r}
tetrachoric(df_pp)
alfa_pp <- psych::alpha(df_pp) #Alfa de cronbach para evaluar fiabilidad
alfa_pp
data$pp_apod<- (data$pp_voto_presi + data$pp_act_comu + data$pp_marcha) #Se agrega indicador a base de datos principal
#Se genera indicador de voto de apoderados (si voto de apoderados es NA, se asume el que respondieron estudiantes)
data$voto_padres <- ifelse(is.na(data$voto_apod), data$pp_voto_presi, data$voto_apod)
data$voto_padres <- as.factor(data$voto_padres)
data$voto_padres <- set_labels(data$voto_padres,
                                labels=c( "No"=0,
                                          "Si"=1))
```

## Participación política de padres (activista)
```{r}
data$act_marcha <- car::recode(data$act_marcha, "2=0; 9=NA")
data$act_marcha <- set_labels(data$act_marcha,
                                labels=c( "No"=0,
                                          "Si"=1))
apod_data$P20B <- car::recode(apod_data$P20B, "2=0")
apod_data$P20B <- set_labels(apod_data$P20B,
                              labels=c( "No"=0,
                                        "Si"=1))
data$act_voluntariado <- car::recode(data$act_voluntariado, "2=0")
data$act_voluntariado <- set_labels(data$act_voluntariado,
                                labels=c( "No"=0,
                                          "Si"=1))
data$act_reu_sociopol <- car::recode(data$act_reu_sociopol, "2=0")
data$act_reu_sociopol <- set_labels(data$act_reu_sociopol,
                                labels=c( "No"=0,
                                          "Si"=1))
data$act_peticion <- car::recode(data$act_peticion, "2=0")
data$act_peticion <- set_labels(data$act_peticion,
                                labels=c( "No"=0,
                                          "Si"=1))
df_act <- data.frame(data$act_voluntariado, data$act_marcha,data$act_peticion, data$act_reu_sociopol)
```
                     
### Correlaciones
```{r}
tetrachoric(df_act)
alfa_act <- psych::alpha(df_act)#Alfa de cronbach para evaluar fiabilidad
alfa_act
data$act_apod <- (data$act_marcha + data$act_peticion + data$act_reu_sociopol) #Se agrega a la base de datos principal
```

## Participación política de padres (organizaciones voluntaria)
* Recodificacion: No miembro = 0, Miembro = 1

```{r}
data$org_asocprof <- car::recode(data$org_asocprof, "1=0;2=1;3=1")
data$org_asocprof <- set_labels(data$org_asocprof,
                           labels=c( "No"=0,
                                     "Si"=1))
data$org_caridad <- car::recode(data$org_caridad, "1=0;2=1;3=1")
data$org_caridad <- set_labels(data$org_caridad,
                                labels=c( "No"=0,
                                          "Si"=1))
data$org_cpadres <- car::recode(data$org_cpadres, "1=0;2=1;3=1")
data$org_cpadres <- set_labels(data$org_cpadres,
                                labels=c( "No"=0,
                                          "Si"=1))
data$org_iglesia <- car::recode(data$org_iglesia, "1=0;2=1;3=1")
data$org_iglesia <- set_labels(data$org_iglesia,
                                labels=c( "No"=0,
                                          "Si"=1))
data$org_juntavecinos <- car::recode(data$org_juntavecinos, "1=0;2=1;3=1")
data$org_juntavecinos <- set_labels(data$org_juntavecinos,
                                labels=c( "No"=0,
                                          "Si"=1))
data$org_ppol <- car::recode(data$org_ppol, "1=0;2=1;3=1")
data$org_ppol <- set_labels(data$org_ppol,
                                labels=c( "No"=0,
                                          "Si"=1))
data$org_sindicato<- car::recode(data$org_sindicato, "1=0;2=1;3=1")
data$org_sindicato <- set_labels(data$org_sindicato,
                                labels=c( "No"=0,
                                          "Si"=1))
```

* Data frame con variables de organizaciones voluntarias

```{r}
df_org <- data.frame(data$org_asocprof, data$org_caridad, data$org_cpadres, 
                     data$org_iglesia, data$org_juntavecinos, data$org_ppol,
                     data$org_sindicato)
```

### Correlaciones
```{r}
tetrachoric(df_org)
#Alfa de Cronbach para evaluar fiabilidad de indicador
alfa_org <- psych::alpha(df_org)
alfa_org
#Se agrega indice sumatico de organizaciones voluntarizs
data$org_vol <- (data$org_asocprof + data$org_caridad +  data$org_cpadres + 
                  data$org_iglesia + data$org_juntavecinos + data$org_ppol +
                  data$org_sindicato)/7
frq(data$org_vol)
```

# Analisis Factorial Confirmatorio
```{r,cache=TRUE}
set.seed(1234)
#Especificacion del Modelo
cfa_1 <- '
# latent variables
formal =~ int_inf + int_pre + int_mun
nodisruptivo =~ par_fir + par_servcom + par_reupol + par_marau
disruptivo =~ par_marnoau + par_toma + par_bloq + par_pared'
#Seleccion de variables
fit_1 <- cfa(cfa_1,data, ordered=c("par_fir","par_marau","par_marnoau","par_toma","par_bloq", "par_pared", "par_servcom", "par_reupol","int_mun","int_pre","int_inf"))

#Resumen ajuste general
show(fit_1) 
#Resumen de indicadores
fitMeasures(fit_1, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea")) 
#Seleccion de variables originales con folio
```

## Factor scores
```{r}
data2 <- data %>% 
  dplyr::select("folio", 
                "par_fir","par_marau","par_marnoau","par_toma","par_bloq", "par_pared",
                "par_servcom", "par_reupol","int_mun","int_pre","int_inf") %>% 
  na.omit()
predict <- predict(fit_1)
#Puntajes factoriales se guardan como df
scores <- as.data.frame(predict)
#Se unen los puntajes factoriales con la variable con el folio
data2 = bind_cols(data2, scores)
#Nueva base de datos con folio y las variables con puntajes factoriales
data3 = data2 %>% dplyr::select(folio, formal, nodisruptivo, disruptivo)
```

# Merge
```{r}
data <-  left_join(x = data, y=data3, by="folio")
data$formal      <- set_label(data$formal,label = "Participación política formal")
data$disruptivo  <- set_label(data$disruptivo,label = "Participación política disruptiva")
data$nodisruptivo<- set_label(data$nodisruptivo,label = "Participación política no disruptiva")
```

# Centrado

```{r}
data<- data %>% 
        dplyr::mutate(quintil=quintiles_ingresos_pc_factor)%>%
        dplyr::group_by(RBDE) %>% # Agrupa los datos
        dplyr::mutate(meancivico = mean(civico, na.rm = TRUE)) %>% # crea promedio para cada escuela
        dplyr::mutate(meanap = mean(apertura, na.rm = TRUE)) %>% # crea promedio para cada escuela
        ungroup() %>% # Desagrupa
        dplyr::mutate(civico_gc = civico - meancivico) %>% # Crea variavble centrada al grupo (escuela)
        dplyr::mutate(apertura_gc = apertura - meanap)     # Crea variavble centrada al grupo (escuela)

data$meancivico <- set_label(data$meancivico ,label = "Indice aprendizaje cívico activo en la escuela (promedio escuela)")  
data$civico_gc  <- set_label(data$civico_gc  ,label = "Indice aprendizaje cívico activo en la escuela (centrado escuela)") 
data$meanap     <- set_label(data$meanap     ,label = "Indice apertura a la discusión en el aula (promedio escuela)")
data$apertura_gc<- set_label(data$apertura_gc,label = "Indice apertura a la discusión en el aula (centrado escuela)")   
```


# Resumen de los datos
```{r, results='asis'}
descr <- data %>% dplyr::select(
  formal,
  disruptivo,
  nodisruptivo,
  act_marcha,
  voto_apod,
  educ_apod,
  pad_libros,
  conversacion,
  apertura,
  civico,
  quintil,
  sexo,
  dependencia,
  region,
  RBDE, 
  meancivico, 
  meanap, 
  civico_gc, 
  apertura_gc)
st_css()
print(dfSummary(descr,
               plain.ascii = FALSE,
               style = "grid",
               tmp.img.dir = "/tmp",
               graph.magnif = 0.75,
               headings = F,  # encabezado
               varnumbers = F, # num variable
               labels.col = T, # etiquetas
               na.col = T,    # missing
               graph.col = T, # plot
               valid.col = T, # n valido
               # col.widths = c(5,5,10,10,10,10)
               ),
     method = "render")
```

# Guardar datos
```{r}
#Guardar base nueva
save(data, file = "../input/data/proc/data.RData")
# Guardar base de datos apoderados
save(apod_data, file = "../input/data/proc/apod_data.RData")
# Guardar base de datos estudiantes
save(est_data, file = "../input/data/proc/est_data.RData")
```

